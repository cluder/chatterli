<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterli - Stream TTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .chat-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        .bg-chatterli {
            background: #fdf2f2;
        }

        .btn-ch {
            background: #e31e24;
            color: white;
            transition: 0.2s;
        }

        .btn-ch:hover {
            background: #b1161a;
        }

        /* Flaggen-Button Stil */
        .lang-btn {
            opacity: 0.5;
            transition: 0.2s;
            cursor: pointer;
            filter: grayscale(100%);
        }

        .lang-btn.active {
            opacity: 1;
            font-weight: bold;
            filter: grayscale(0%);
            transform: scale(1.1);
        }
    </style>
</head>

<body class="bg-chatterli min-h-screen font-sans">
    <div class="max-w-4xl mx-auto p-6">
        <!-- HEADER -->
        <header class="flex items-center justify-between mb-8 border-b pb-4">
            <div class="flex items-center gap-2">
                <a href="https://chatterli.core-dump.ch/"
                    class="text-3xl font-bold text-red-600 hover:text-red-700 transition">
                    Chatterli
                </a>
                <span class="text-gray-400 text-lg">üá®üá≠</span>
                <span class="text-xs text-gray-400 font-mono mt-2" title="Version">v2025.01.11</span>
            </div>

            <div class="flex items-center gap-4">
                <!-- Sprachumschalter -->
                <div class="flex gap-2 bg-white px-2 py-1 rounded-full border shadow-sm">
                    <button onclick="setLang('de')" id="btn-de" class="lang-btn active text-lg"
                        title="Deutsch">üá©üá™</button>
                    <div class="text-gray-300">|</div>
                    <button onclick="setLang('en')" id="btn-en" class="lang-btn text-lg" title="English">üá∫üá∏</button>
                </div>

                <!-- Status -->
                <div id="status" class="text-sm px-3 py-1 bg-gray-200 rounded-full text-gray-600 font-medium"
                    data-i18n="status_offline">Offline</div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- SIDEBAR: CONTROLS -->
            <div class="space-y-4">

                <!-- 1. SETTINGS / VOICE BOX (NEU) -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100">
                    <h2 class="font-bold mb-3 text-gray-800 flex items-center gap-2">
                        <span class="text-blue-500">‚öôÔ∏è</span>
                        <span data-i18n="settings_title">Einstellungen</span>
                    </h2>

                    <label class="text-xs font-bold text-gray-500 mb-1 block" data-i18n="voice_label">TTS Stimme</label>
                    <select id="voiceSelect" onchange="changeVoice()"
                        class="w-full p-2 border rounded text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-200">
                        <option value="local">üíª Windows / Lokal / Free</option>
                    </select>

                    <!-- Lokale Stimmen Auswahl (versteckt per Default) -->
                    <div id="localVoiceContainer" class="mt-2 hidden">
                        <label class="text-xs font-bold text-gray-500 mb-1 block" data-i18n="local_voice_label">Lokale
                            Stimme</label>
                        <select id="localVoiceSelect"
                            class="w-full p-2 border rounded text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-200"
                            onchange="updateLocalVoicePreferences()">
                            <option value="">Lade Stimmen...</option>
                        </select>
                    </div>
                    </select>
                </div>

                <!-- Volume Slider -->
                <div class="mt-4">
                    <label class="text-xs font-bold text-gray-500 mb-1 flex justify-between">
                        <span data-i18n="volume_label">Lautst√§rke</span>
                        <span id="volValue" class="text-gray-400">100%</span>
                    </label>
                    <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-500"
                        oninput="updateVolume()">
                </div>
            </div>

            <!-- 2. Channels Box -->
            <div class="bg-white p-4 rounded-xl shadow-sm border">
                <h2 class="font-bold mb-3 text-gray-800" data-i18n="connect_title">Kan√§le verbinden</h2>

                <div class="mb-4">
                    <label class="text-xs font-bold text-purple-600 mb-1 block">TWITCH</label>
                    <input id="twitchChan" type="text" placeholder="Kanalname (z.B. gronkh)"
                        onkeypress="handleEnter(event, 'twitch')"
                        class="w-full p-2 border rounded mb-2 text-sm focus:ring-2 focus:ring-purple-200 outline-none transition">
                    <button id="btnTwitch" onclick="toggleTwitch()"
                        class="w-full btn-ch p-2 rounded text-sm font-bold bg-purple-600 hover:bg-purple-700"
                        data-i18n="btn_twitch">Twitch Verbinden</button>
                </div>

                <hr class="my-4 border-gray-100">

                <div>
                    <label class="text-xs font-bold text-red-600 mb-1 block">YOUTUBE</label>
                    <input id="youtubeId" type="text" placeholder="Channel ID oder Handle"
                        onkeypress="handleEnter(event, 'youtube')"
                        class="w-full p-2 border rounded mb-2 text-sm focus:ring-2 focus:ring-red-200 outline-none transition">
                    <button id="btnYoutube" onclick="toggleYoutube()"
                        class="w-full btn-ch p-2 rounded text-sm font-bold" data-i18n="btn_youtube">YouTube
                        Verbinden</button>
                </div>
            </div>

            <!-- 3. Disconnect & Mute Box -->
            <div class="bg-white p-4 rounded-xl shadow-sm border">
                <h2 class="font-bold mb-3 text-gray-800" data-i18n="control_title">Steuerung</h2>

                <button onclick="disconnectAll()"
                    class="w-full mb-4 p-2 rounded text-sm font-bold bg-gray-500 hover:bg-gray-600 text-white transition flex items-center justify-center gap-2">
                    <span class="text-lg">‚èπ</span> <span data-i18n="btn_disconnect">Trennen & Stop</span>
                </button>

                <h2 class="font-bold mb-2 text-gray-800 text-sm" data-i18n="mute_title">Stumme User</h2>
                <div id="muteList" class="text-xs space-y-1 text-gray-500 italic max-h-32 overflow-y-auto">
                    <span data-i18n="no_muted">Keine</span>
                </div>
            </div>
        </div>

        <!-- MAIN: CHAT HISTORY -->
        <div class="md:col-span-2 space-y-4">
            <div id="chatBox" class="bg-white rounded-xl shadow-sm border h-[500px] flex flex-col">
                <div class="p-3 border-b bg-gray-50 font-bold text-sm text-gray-700 flex justify-between">
                    <span data-i18n="chat_title">Live Chat Nachrichten</span>
                    <button onclick="clearChat()" class="text-xs text-gray-400 hover:text-red-500"
                        data-i18n="clear_chat">Leeren</button>
                </div>
                <div id="messages" class="chat-scroll flex-1 p-4 space-y-3">
                    <div class="text-gray-400 text-sm text-center mt-10 italic" data-i18n="waiting_msg">Warte auf
                        Nachrichten...</div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        const socket = io();

        // Queue speichert jetzt Objekte: { type: 'server'|'local', data: ... }
        const audioQueue = [];
        let isPlaying = false;

        // --- TRANSLATION LOGIC ---
        let currentLang = localStorage.getItem('chatterli_lang') || 'de';
        let twitchConnected = false;
        let currentTwitchChannel = "";
        let youtubeConnected = false;

        const translations = {
            de: {
                status_offline: "Offline",
                status_connected: "Verbunden",
                connect_title: "Kan√§le verbinden",
                settings_title: "Einstellungen",
                voice_label: "TTS Stimme",
                btn_twitch: "Twitch verbinden",
                btn_youtube: "YouTube verbinden",
                control_title: "Steuerung",
                btn_disconnect: "Trennen & Stop",
                mute_title: "Stumme User",
                no_muted: "Keine",
                local_voice_label: "Lokale Stimme",
                volume_label: "Lautst√§rke",
                chat_title: "Live Chat Nachrichten",
                clear_chat: "Leeren",
                waiting_msg: "Warte auf Nachrichten...",
                mute_btn: "STUMM",
                ph_twitch: "Kanalname (z.B. gronkh)",
                ph_youtube: "Channel ID oder Handle",
                btn_twitch_connected: "Verbunden: $1 (Trennen)",
                btn_youtube_connected: "Verbunden (Trennen)"
            },
            en: {
                status_offline: "Offline",
                status_connected: "Connected",
                connect_title: "Connect Channels",
                settings_title: "Settings",
                voice_label: "TTS Voice",
                btn_twitch: "Connect Twitch",
                btn_youtube: "Connect YouTube",
                control_title: "Controls",
                btn_disconnect: "Disconnect & Stop",
                mute_title: "Muted Users",
                no_muted: "None",
                local_voice_label: "Local Voice",
                volume_label: "Volume",
                chat_title: "Live Chat Messages",
                clear_chat: "Clear",
                waiting_msg: "Waiting for messages...",
                mute_btn: "MUTE",
                ph_twitch: "Channel Name (e.g. ninja)",
                ph_youtube: "Channel ID or Handle",
                btn_twitch_connected: "Connected: $1 (Disconnect)",
                btn_youtube_connected: "Connected (Disconnect)"
            }
        };

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('chatterli_lang', lang);

            // Buttons visual update
            document.getElementById('btn-de').classList.toggle('active', lang === 'de');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');

            // Text content update
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');

                // Handle Connected States Dynamic Text
                if (key === 'btn_twitch' && twitchConnected) {
                    el.innerText = translations[lang]['btn_twitch_connected'].replace('$1', currentTwitchChannel);
                    return;
                }
                if (key === 'btn_youtube' && youtubeConnected) {
                    el.innerText = translations[lang]['btn_youtube_connected'];
                    return;
                }

                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // Placeholder updates
            document.getElementById('twitchChan').placeholder = translations[lang]['ph_twitch'];
            document.getElementById('youtubeId').placeholder = translations[lang]['ph_youtube'];
        }

        // Init Language on Load
        setLang(currentLang);

        // --- SOCKET LOGIC ---

        // Lokale Stimmen laden
        let localVoices = [];
        let selectedLocalVoiceURI = localStorage.getItem('chatterli_local_voice');

        function loadLocalVoices() {
            localVoices = window.speechSynthesis.getVoices();
            const select = document.getElementById('localVoiceSelect');
            select.innerHTML = '';

            if (localVoices.length === 0) {
                select.innerHTML = '<option value="">Keine Stimmen gefunden</option>';
                return;
            }

            localVoices.forEach(voice => {
                const opt = document.createElement('option');
                opt.value = voice.voiceURI;
                opt.textContent = `${voice.name} (${voice.lang})`;
                if (voice.voiceURI === selectedLocalVoiceURI) opt.selected = true;
                select.appendChild(opt);
            });
        }

        // Stimmen laden, da Browser dies oft async machen
        window.speechSynthesis.onvoiceschanged = loadLocalVoices;
        loadLocalVoices();

        function updateLocalVoicePreferences() {
            const select = document.getElementById('localVoiceSelect');
            selectedLocalVoiceURI = select.value;
            localStorage.setItem('chatterli_local_voice', selectedLocalVoiceURI);
        }

        // Volume Logic
        let currentVolume = parseFloat(localStorage.getItem('chatterli_volume') || '1');
        document.getElementById('volumeSlider').value = currentVolume;
        document.getElementById('volValue').innerText = Math.round(currentVolume * 100) + '%';

        function updateVolume() {
            currentVolume = parseFloat(document.getElementById('volumeSlider').value);
            document.getElementById('volValue').innerText = Math.round(currentVolume * 100) + '%';
            localStorage.setItem('chatterli_volume', currentVolume);
        }

        // --- PERSISTENCE & ENTER LOGIC ---
        // Load saved channels
        document.getElementById('twitchChan').value = localStorage.getItem('chatterli_twitch_chan') || '';
        document.getElementById('youtubeId').value = localStorage.getItem('chatterli_youtube_id') || '';

        function handleEnter(e, platform) {
            if (e.key === 'Enter') {
                if (platform === 'twitch') toggleTwitch();
                if (platform === 'youtube') toggleYoutube();
            }
        }

        socket.on('connect', () => {
            const statusEl = document.getElementById('status');
            statusEl.setAttribute('data-i18n', 'status_connected'); // Update key for translation
            statusEl.innerText = translations[currentLang]['status_connected'];
            statusEl.className = "text-sm px-3 py-1 bg-green-100 rounded-full text-green-600 font-medium";

            // Sync Voice mit Server
            changeVoice();

            // RECONNECT LOGIC: Wenn wir schon verbunden waren, Channel wieder joinen
            if (typeof twitchConnected !== 'undefined' && twitchConnected) {
                const chan = document.getElementById('twitchChan').value;
                if (chan) {
                    console.log("Restoring Twitch connection...");
                    socket.emit('join_twitch', chan);
                }
            }
            if (typeof youtubeConnected !== 'undefined' && youtubeConnected) {
                const id = document.getElementById('youtubeId').value;
                if (id) {
                    console.log("Restoring YouTube connection...");
                    socket.emit('join_youtube', id);
                }
            }
        });

        socket.on('disconnect', () => {
            const statusEl = document.getElementById('status');
            statusEl.setAttribute('data-i18n', 'status_offline'); // Reset key
            statusEl.innerText = translations[currentLang]['status_offline'];
            statusEl.className = "text-sm px-3 py-1 bg-gray-200 rounded-full text-gray-600 font-medium";
        });

        function changeVoice() {
            const voiceId = document.getElementById('voiceSelect').value;

            // Zeige/Verstecke lokale Stimmen Box
            const localBox = document.getElementById('localVoiceContainer');
            if (voiceId === 'local') {
                localBox.classList.remove('hidden');
            } else {
                localBox.classList.add('hidden');
            }

            socket.emit('change_voice', voiceId);
        }

        // --- TOGGLE LOGIC ---
        let twitchTimeout = null;

        function toggleTwitch() {
            if (twitchConnected) {
                socket.emit('leave_twitch');
            } else {
                let chan = document.getElementById('twitchChan').value.trim();

                // URL Parsing Logic
                // Entfernt https://, www., twitch.tv/ und alles nach dem Namen (z.B. ?search=...)
                // Bsp: https://www.twitch.tv/kaezuhots -> kaezuhots
                // Bsp: twitch.tv/kaezuhots -> kaezuhots
                try {
                    // Wenn es wie eine URL aussieht (beinhaltet twitch.tv oder /)
                    if (chan.includes('twitch.tv') || chan.includes('/')) {
                        // Falls kein Protokoll, h√§nge https:// vorne dran f√ºr sauberes URL parsing
                        if (!chan.startsWith('http')) {
                            chan = 'https://' + chan;
                        }
                        const url = new URL(chan);
                        // pathname ist z.B. /kaezuhots oder /kaezuhots/videos
                        const parts = url.pathname.split('/').filter(p => p.length > 0);
                        if (parts.length > 0) {
                            chan = parts[0]; // Nehme das erste Segment als Kanalname
                        }
                    }
                } catch (e) {
                    console.error("Fehler beim Parsen der URL, versuche Originalwert", e);
                }

                if (!chan) return;

                // Update input to show clean name
                document.getElementById('twitchChan').value = chan;

                // Save to storage
                localStorage.setItem('chatterli_twitch_chan', chan);

                const btn = document.getElementById('btnTwitch');
                btn.innerText = "Connecting...";
                btn.disabled = true;

                // Safety Timeout (15s)
                if (twitchTimeout) clearTimeout(twitchTimeout);
                twitchTimeout = setTimeout(() => {
                    if (!twitchConnected) {
                        resetTwitchBtn();
                        alert("Twitch Connection Timeout");
                    }
                }, 15000);

                socket.emit('join_twitch', chan);
            }
        }

        socket.on('twitch_connected', (channel) => {
            twitchConnected = true;
            currentTwitchChannel = channel;
            if (twitchTimeout) clearTimeout(twitchTimeout);
            const btn = document.getElementById('btnTwitch');
            btn.innerText = translations[currentLang]['btn_twitch_connected'].replace('$1', channel);
            btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.disabled = false;
        });

        socket.on('twitch_connect_error', () => {
            resetTwitchBtn();
        });

        function resetTwitchBtn() {
            if (twitchTimeout) clearTimeout(twitchTimeout);
            twitchConnected = false;
            const btn = document.getElementById('btnTwitch');
            btn.innerText = translations[currentLang]['btn_twitch'];
            btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.disabled = false;
        }

        socket.on('twitch_disconnected', () => {
            resetTwitchBtn();
        });

        let youtubeTimeout = null;

        function toggleYoutube() {
            if (youtubeConnected) {
                socket.emit('leave_youtube');
            } else {
                const id = document.getElementById('youtubeId').value;
                if (!id) return;
                // Save to storage
                localStorage.setItem('chatterli_youtube_id', id);

                const btn = document.getElementById('btnYoutube');
                btn.innerText = "Connecting...";
                btn.disabled = true;

                // Safety Timeout (15s)
                if (youtubeTimeout) clearTimeout(youtubeTimeout);
                youtubeTimeout = setTimeout(() => {
                    if (!youtubeConnected) {
                        resetYoutubeBtn();
                        alert("YouTube Connection Timeout");
                    }
                }, 15000);

                socket.emit('join_youtube', id);
            }
        }

        socket.on('youtube_connected', (id) => {
            youtubeConnected = true;
            if (youtubeTimeout) clearTimeout(youtubeTimeout);
            const btn = document.getElementById('btnYoutube');
            btn.innerText = translations[currentLang]['btn_youtube_connected'];
            btn.classList.remove('btn-ch');
            btn.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
            btn.disabled = false;
        });

        socket.on('youtube_connect_error', () => {
            resetYoutubeBtn();
        });

        function resetYoutubeBtn() {
            if (youtubeTimeout) clearTimeout(youtubeTimeout);
            youtubeConnected = false;
            const btn = document.getElementById('btnYoutube');
            btn.innerText = translations[currentLang]['btn_youtube'];
            btn.classList.add('btn-ch');
            btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            btn.disabled = false;
        }

        socket.on('youtube_disconnected', () => {
            resetYoutubeBtn();
        });

        function disconnectAll() {
            // 1. Lokale Queue leeren
            audioQueue.length = 0;
            isPlaying = false;
            window.speechSynthesis.cancel(); // Stoppt Browser TTS sofort

            // 2. Server informieren
            socket.emit('disconnect_channels');
        }

        function clearChat() {
            document.getElementById('messages').innerHTML = `<div class="text-gray-400 text-sm text-center mt-10 italic" data-i18n="waiting_msg">${translations[currentLang]['waiting_msg']}</div>`;
        }

        socket.on('system_msg', (msg) => {
            let displayMsg = msg;
            if (msg.includes("Verbunden mit")) displayMsg = currentLang === 'en' ? msg.replace("Verbunden mit", "Connected to") : msg;
            addMessage('System', displayMsg, 'gray');
        });

        socket.on('blocklist_update', (list) => {
            const div = document.getElementById('muteList');
            if (list.length === 0) {
                div.innerHTML = `<span data-i18n="no_muted">${translations[currentLang]['no_muted']}</span>`;
                return;
            }
            div.innerHTML = list.map(u => `
                <div class="flex justify-between items-center bg-gray-50 p-1 rounded border mb-1">
                    <span class="font-mono text-gray-600">${u}</span>
                    <button onclick="unmute('${u}')" class="text-red-500 font-bold hover:bg-red-50 px-2 rounded">‚úï</button>
                </div>
            `).join('');
        });

        socket.on('chat_message', (data) => {
            addMessage(data.user, data.text, data.platform === 'twitch' ? 'purple' : 'red', data.id);

            // Audio Queue Logik
            if (data.audio) {
                // Server hat MP3 Audio geschickt (Google TTS)
                audioQueue.push({ type: 'server', content: data.audio });
            } else {
                // Server hat KEIN Audio geschickt -> Wir nutzen Lokale Stimme
                // Wir nehmen an, wenn data.audio null ist, ist "local" ausgew√§hlt
                audioQueue.push({ type: 'local', text: `${data.user}: ${data.text}` });
            }

            playNext();
        });

        function addMessage(user, text, color, id) {
            const container = document.getElementById('messages');
            if (container.querySelector('[data-i18n="waiting_msg"]')) container.innerHTML = '';

            const msgDiv = document.createElement('div');
            msgDiv.className = `p-3 rounded-lg bg-gray-50 border-l-4 border-${color}-500 flex justify-between items-start shadow-sm hover:shadow-md transition`;
            msgDiv.innerHTML = `
                <div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-${color}-600 text-sm">${user}</span>
                        ${id ? `<span class="text-xs text-gray-400 font-medium">${new Date().toLocaleTimeString()}</span>` : ''}
                    </div>
                    <span class="text-gray-700 text-sm leading-relaxed block mt-1">${text}</span>
                </div>
                ${user !== 'System' ? `<button onclick="mute('${user}')" class="text-[10px] text-gray-400 hover:text-red-500 font-bold tracking-wider ml-2 py-1 px-2 border border-transparent hover:border-red-200 rounded transition">${translations[currentLang]['mute_btn']}</button>` : ''}
            `;
            container.prepend(msgDiv);
        }

        function mute(user) { socket.emit('mute_user', user); }
        function unmute(user) { socket.emit('unmute_user', user); }

        function playNext() {
            if (isPlaying || audioQueue.length === 0) return;

            const task = audioQueue[0];
            isPlaying = true;

            if (task.type === 'server') {
                // Google Cloud MP3 abspielen
                const audio = new Audio("data:audio/mp3;base64," + task.content);
                audio.volume = currentVolume; // Set Volume
                audio.onended = () => {
                    audioQueue.shift(); // Task entfernen
                    isPlaying = false;
                    playNext();
                };
                audio.play().catch(e => {
                    console.error("Audio play error", e);
                    audioQueue.shift();
                    isPlaying = false;
                });
            } else if (task.type === 'local') {
                // Lokale Browser Stimme nutzen
                const utterance = new SpeechSynthesisUtterance(task.text);
                utterance.volume = currentVolume; // Set Volume

                // Setze spezifische Stimme wenn ausgew√§hlt
                if (selectedLocalVoiceURI) {
                    const specificVoice = localVoices.find(v => v.voiceURI === selectedLocalVoiceURI);
                    if (specificVoice) {
                        utterance.voice = specificVoice;
                    }
                }

                // Fallback Lang
                if (!utterance.voice) {
                    utterance.lang = currentLang === 'de' ? 'de-DE' : 'en-US';
                }

                utterance.onend = () => {
                    audioQueue.shift(); // Task entfernen
                    isPlaying = false;
                    playNext();
                };

                // Falls Browser Probleme hat
                utterance.onerror = () => {
                    audioQueue.shift();
                    isPlaying = false;
                    playNext();
                };

                window.speechSynthesis.speak(utterance);
            }
        }
    </script>
</body>

</html>